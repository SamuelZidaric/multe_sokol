<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Basketball Tracker - Multe & Sokol</title>
  <link rel="stylesheet" href="style.css">

  <!-- React and ReactDOM from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone for JSX transformation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <!-- Main application script -->
  <script type="text/babel" src="script.js"></script>

  <!-- Bootstrap the React application -->
  <script type="text/babel">
    const { useState, useEffect } = React;

    const BasketballTracker = () => {
      // State for data loaded from JSON
      const [playersData, setPlayersData] = useState([]);
      const [multeTypesData, setMulteTypesData] = useState([]);
      const [playerMulte, setPlayerMulte] = useState({});

      // Load data from JSON files
      useEffect(() => {
        // Load players data
        fetch('./players.json')
          .then(response => response.json())
          .then(data => {
            setPlayersData(data);
            // Initialize player multe structure
            const initial = {};
            data.forEach(p => {
              initial[p.id] = [];
            });

            // Load player multe data from JSON
            fetch('./player-multe.json')
              .then(response => response.json())
              .then(multeData => {
                // Merge loaded multe data with initialized structure
                Object.keys(multeData).forEach(playerId => {
                  initial[playerId] = multeData[playerId];
                });
                setPlayerMulte(initial);
              })
              .catch(error => {
                console.error('Error loading player multe:', error);
                setPlayerMulte(initial); // Use empty multe if file not found
              });
          })
          .catch(error => console.error('Error loading players:', error));

        // Load multe types data
        fetch('./multe-types.json')
          .then(response => response.json())
          .then(data => setMulteTypesData(data))
          .catch(error => console.error('Error loading multe types:', error));
      }, []);

      // State management (removed beer-related state)

      // Calculate player multe stats
      const playerMulteStats = () => {
        if (!playersData.length || !multeTypesData.length) return [];

        const stats = [];
        playersData.forEach(player => {
          const multe = playerMulte[player.id] || [];
          if (multe.length > 0) {
            const totalCount = multe.reduce((sum, m) => sum + m.count, 0);
            let totalEuro = 0;
            let kasaCount = 0;
            let merendaCount = 0;

            multe.forEach(m => {
              const multaType = multeTypesData.find(mt => mt.id === m.multaId);
              if (multaType) {
                if (typeof multaType.price === 'number') {
                  totalEuro += multaType.price * m.count;
                } else if (multaType.price === 'KASA') {
                  kasaCount += m.count;
                } else if (multaType.price === 'MERENDA') {
                  merendaCount += m.count;
                }
              }
            });

            stats.push({
              player,
              multe,
              totalCount,
              totalEuro,
              kasaCount,
              merendaCount
            });
          }
        });

        return stats.sort((a, b) => b.totalCount - a.totalCount);
      };

      const stats = playerMulteStats();
      const totalMulteCount = stats.reduce((sum, s) => sum + s.totalCount, 0);
      const totalEuroSum = stats.reduce((sum, s) => sum + s.totalEuro, 0);
      const totalKasa = stats.reduce((sum, s) => sum + s.kasaCount, 0);
      const totalMerenda = stats.reduce((sum, s) => sum + s.merendaCount, 0);

      return (
        <div className="app-container">
          <h1 className="app-title">
            Basketball Tracker - Multe & Sokol
          </h1>

          {/* Multe Section */}
          <div className="section section-player-multe">
            <h2 className="section-title section-title-purple">MULTE</h2>
            <PlayerMulteStats
              stats={stats}
              multeTypesData={multeTypesData}
              totalMulteCount={totalMulteCount}
              totalEuroSum={totalEuroSum}
              totalKasa={totalKasa}
              totalMerenda={totalMerenda}
            />
          </div>

          {/* Legend Section */}
          <div className="section section-multe-list">
            <h2 className="section-title section-title-orange">LEGEND</h2>
            <div className="multe-grid">
              {multeTypesData.map(multa => (
                <div key={multa.id}>
                  <strong>{multa.id}.</strong> {multa.name} - {' '}
                  {typeof multa.price === 'number' ? (
                    <strong>{multa.price}€</strong>
                  ) : multa.price === 'KASA' ? (
                    <span className="badge badge-kasa">KASA</span>
                  ) : (
                    <span className="badge badge-merenda">MERENDA</span>
                  )}
                </div>
              ))}
            </div>
            <div className="multe-note">
              <p><strong>Note:</strong></p>
              <p><span className="badge badge-kasa">KASA</span> = Il giocatore offre birre per tutta la squadra</p>
              <p><span className="badge badge-merenda">MERENDA</span> = Kasa + Cena per tutta la squadra</p>
            </div>
          </div>
        </div>
      );
    };

    // Components
    const PlayerMulteStats = ({ stats, multeTypesData, totalMulteCount, totalEuroSum, totalKasa, totalMerenda }) => {
      if (stats.length === 0) {
        return <p>Nessuna multa registrata ancora.</p>;
      }

      return (
        <div className="stats-grid">
          <div className="stats-total">
            <h3>Statistiche Totali</h3>
            <div className="stats-total-grid">
              <div>
                <strong>Multe totali</strong>
                <div style={{fontSize: '2.5em', fontWeight: '700', marginTop: '5px'}}>{totalMulteCount}</div>
              </div>
              <div>
                <strong>Euro totali</strong>
                <div style={{fontSize: '2.5em', fontWeight: '700', marginTop: '5px'}}>{totalEuroSum.toFixed(2)}€</div>
              </div>
              <div>
                <strong>KASA totali</strong>
                <div style={{fontSize: '2.5em', fontWeight: '700', marginTop: '5px'}}>{totalKasa}</div>
              </div>
              <div>
                <strong>MERENDA totali</strong>
                <div style={{fontSize: '2.5em', fontWeight: '700', marginTop: '5px'}}>{totalMerenda}</div>
              </div>
            </div>
          </div>
          {stats.map(stat => (
            <div key={stat.player.id} className="player-card">
              <strong>{stat.player.name} {stat.player.surname}</strong> {stat.player.alias !== 'ND' && `(${stat.player.alias})`}
              <div style={{marginTop: '8px'}}>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px', backgroundColor: '#f3e5f5', borderRadius: '8px', marginBottom: '10px'}}>
                  <strong style={{fontSize: '1.05em', color: '#555'}}>Totale multe:</strong>
                  <span style={{fontSize: '1.8em', fontWeight: '700', color: '#6a1b9a'}}>{stat.totalCount}</span>
                </div>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px', backgroundColor: '#fff3e0', borderRadius: '8px', marginBottom: '10px'}}>
                  <strong style={{fontSize: '1.05em', color: '#555'}}>Totale €:</strong>
                  <span style={{fontSize: '1.8em', fontWeight: '700', color: '#d84315'}}>{stat.totalEuro.toFixed(2)}€</span>
                </div>
                {stat.kasaCount > 0 && (
                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px', backgroundColor: '#fff3e0', borderRadius: '8px', marginBottom: '10px'}}>
                    <span className="badge badge-kasa">KASA</span>
                    <span style={{fontSize: '1.6em', fontWeight: '700', color: '#ff6f00'}}>{stat.kasaCount}x</span>
                  </div>
                )}
                {stat.merendaCount > 0 && (
                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px', backgroundColor: '#ffebee', borderRadius: '8px', marginBottom: '10px'}}>
                    <span className="badge badge-merenda">MERENDA</span>
                    <span style={{fontSize: '1.6em', fontWeight: '700', color: '#c62828'}}>{stat.merendaCount}x</span>
                  </div>
                )}
              </div>
              <div className="player-card-multe-list">
                {stat.multe.map((m, idx) => {
                  const multaType = multeTypesData.find(mt => mt.id === m.multaId);
                  if (!multaType) return null;
                  const priceStr = typeof multaType.price === 'number' ? `${multaType.price}€` :
                                  multaType.price === 'KASA' ? 'KASA' : 'MERENDA';
                  return (
                    <div key={idx} className="multa-item">
                      <strong>{m.count}x</strong> {multaType.name} - {priceStr}
                    </div>
                  );
                })}
              </div>
            </div>
          ))}
        </div>
      );
    };

    // Render the application
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<BasketballTracker />);
  </script>
</body>
</html>
